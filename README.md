# Excel 三表比对与漏填检查工具

## 📘 功能概述

该工具用于自动比对财务表、方案1、方案2与字段表中的合同数据，主要功能包括：

-   对比并标出数值差异（如提成金额、保证金比例等）。
-   漏填检查：确保字段表中的合同都已填写在三张表中。
-   自动跳过以下不需检查的合同：
    -   "是否车管家"为"是"
    -   "提成类型"为"联合租赁"或"驻店"
-   输出 4 张完整比对表 + 1 张仅包含漏填记录的表。

## 📂 输出文件

程序运行后可下载以下表格：

  输出文件                 内容说明
  ------------------------ ----------------------------------------
  **财务表_输出.xlsx**     比对完成的财务表
  **方案1_输出.xlsx**      比对完成的方案1
  **方案2_输出.xlsx**      比对完成的方案2
  **字段表_输出.xlsx**     原字段表中未在三表中出现的合同号被标黄
  **字段表_仅漏填.xlsx**   仅包含漏填合同记录

------------------------------------------------------------------------

## ⚙️ 开发者调试与参数扩展指南

### 1️⃣ 差异容差调整

默认设置为：当保证金比例差距小于 `0.005` 时，不标红。\
如需修改，可在脚本中查找以下部分：

``` python
if abs(value1 - value2) > 0.005:
```

调整 `0.005` 的值即可修改精度容差。

### 2️⃣ 跳过规则扩展

目前脚本自动跳过： - `是否车管家 == "是"`\
- `提成类型 == "联合租赁"`\
- `提成类型 == "驻店"`

如需增加新规则，可修改以下逻辑：

``` python
skip_mask = (
    (df_field['是否车管家'] == '是') |
    (df_field['提成类型'].isin(['联合租赁', '驻店']))
)
```

在 `isin([])` 中添加更多类型即可。

### 3️⃣ 调试输出与日志

在开发模式中，可以打印中间 DataFrame 结果：

``` python
print(df_missing.shape)
print(df_field.columns)
```

便于核对数据结构和调试匹配逻辑。

------------------------------------------------------------------------

## 🧩 使用说明

1.  通过 Streamlit 上传四张 Excel：
    -   字段表
    -   财务表
    -   方案1
    -   方案2\
2.  点击 **开始检查**
3.  程序将自动：
    -   比对差异
    -   检查漏填
    -   输出 4 张完整表与 1 张仅漏填表\
4.  可单独下载每个表，或使用"一键下载全部"按钮。

------------------------------------------------------------------------

## 📦 一键下载说明

点击"一键下载全部"后，将生成一个压缩包：

    all_outputs.zip
    ├─ 财务表_输出.xlsx
    ├─ 方案1_输出.xlsx
    ├─ 方案2_输出.xlsx
    ├─ 字段表_输出.xlsx
    └─ 字段表_仅漏填.xlsx

------------------------------------------------------------------------

## 🧠 开发备注

-   使用 `pandas` 进行表格比对。
-   使用 `openpyxl` 写入样式（标红、标黄）。
-   可在 `st.download_button()` 中配置多个文件或压缩输出。

------------------------------------------------------------------------

**版本：v1.4 完整整合版（含容差跳过 + 一键下载 + 漏填统计）**
